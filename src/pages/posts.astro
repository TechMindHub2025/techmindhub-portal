---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const sort = (Astro.url.searchParams.get("sort") ?? "newest").toLowerCase();
const tag = (Astro.url.searchParams.get("tag") ?? "").trim().toLowerCase();

const all = await getCollection("posts");

// Only published
let posts = all
  .filter((p) => p.data.status === "published")
  .filter((p) => (tag ? (p.data.tags ?? []).map((t) => t.toLowerCase()).includes(tag) : true));

// Sort
posts = posts.sort((a, b) => {
  const da = new Date(a.data.pubDate).getTime();
  const db = new Date(b.data.pubDate).getTime();

  if (sort === "oldest") return da - db;
  if (sort === "title") return a.data.title.localeCompare(b.data.title);
  // newest (default)
  return db - da;
});

const allTags = Array.from(
  new Set(
    all
      .filter((p) => p.data.status === "published")
      .flatMap((p) => p.data.tags ?? [])
      .map((t) => t.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
---

<BaseLayout title="Posts — TechMind Hub" description="Latest TechMind Hub posts and notes.">
  <section class="page">
    <div class="pageHead">
      <div>
        <h1>Posts</h1>
        <p class="lead">
          A curated feed of signals across AI, robotics, automation, and enterprise tech.
        </p>
      </div>

      <form class="controls" method="get" action="/posts">
        {tag ? <input type="hidden" name="tag" value={tag} /> : null}
        <label class="control">
          <span>Sort</span>
          <select name="sort" onchange="this.form.submit()">
            <option value="newest" selected={sort === "newest"}>Newest</option>
            <option value="oldest" selected={sort === "oldest"}>Oldest</option>
            <option value="title" selected={sort === "title"}>Title</option>
          </select>
        </label>
      </form>
    </div>

    <div class="tagBar">
      <a class={"tagChip " + (!tag ? "active" : "")} href="/posts">All</a>
      {allTags.map((t) => (
        <a
          class={"tagChip " + (tag === t.toLowerCase() ? "active" : "")}
          href={`/posts?tag=${encodeURIComponent(t)}&sort=${encodeURIComponent(sort)}`}
        >
          #{t}
        </a>
      ))}
    </div>

    {posts.length === 0 ? (
      <div class="empty">
        <p>No posts found{tag ? ` for #${tag}` : ""}.</p>
      </div>
    ) : (
      <div class="grid">
        {posts.map((post) => {
          const href = `/posts/${post.slug}/`;
          const cover = post.data.cover_card || post.data.cover_hero;

          return (
            <article class="card">
              <a class="coverLink" href={href} aria-label={post.data.title}>
                <img
                  class="cover"
                  src={cover}
                  alt={post.data.title}
                  loading="lazy"
                />
              </a>

              <div class="cardBody">
                <h2 class="title">
                  <a href={href}>{post.data.title}</a>
                </h2>

                <time class="date" datetime={new Date(post.data.pubDate).toISOString()}>
                  {new Date(post.data.pubDate).toISOString().slice(0, 10)}
                </time>

                <p class="desc">{post.data.description}</p>

                <div class="metaRow">
                  <div class="tags">
                    {(post.data.tags ?? []).slice(0, 6).map((t) => (
                      <a
                        class="pill"
                        href={`/posts?tag=${encodeURIComponent(t)}&sort=${encodeURIComponent(sort)}`}
                      >
                        #{t}
                      </a>
                    ))}
                  </div>

                  <a class="source" href={post.data.source_url} target="_blank" rel="noreferrer">
                    Source ↗
                  </a>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    )}
  </section>

  <style>
    .page { padding: 28px 0 40px; }
    .pageHead { display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap; }
    h1 { margin: 0; font-size: 34px; letter-spacing: -0.02em; color: var(--tmh-text); }
    .lead { margin: 8px 0 0; color: var(--tmh-muted); max-width: 64ch; }

    .controls { display:flex; gap:12px; align-items:center; }
    .control { display:flex; gap:10px; align-items:center; color: var(--tmh-muted); }
    .control span { font-size: 13px; }
    select {
      border: 1px solid var(--tmh-border);
      background: var(--tmh-card);
      padding: 8px 10px;
      border-radius: 10px;
      color: var(--tmh-text);
      outline: none;
    }

    .tagBar { margin: 18px 0 22px; display:flex; flex-wrap:wrap; gap:10px; }
    .tagChip {
      display:inline-flex; align-items:center;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--tmh-border);
      background: var(--tmh-card);
      color: var(--tmh-text);
      text-decoration:none;
      font-size: 13px;
    }
    .tagChip:hover { border-color: rgba(0,70,175,0.35); }
    .tagChip.active {
      border-color: rgba(0,70,175,0.45);
      box-shadow: 0 0 0 3px rgba(0,207,253,0.12);
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }

    .card {
      border: 1px solid var(--tmh-border);
      background: var(--tmh-card);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }

    .coverLink { display:block; }
    .cover {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      display:block;
      background: #eef3f8;
    }

    .cardBody { padding: 14px 14px 16px; }
    .title { margin: 0; font-size: 18px; line-height: 1.25; }
    .title a { color: var(--tmh-text); text-decoration:none; }
    .title a:hover { text-decoration: underline; }

    .date { display:block; margin-top: 8px; font-size: 12px; color: var(--tmh-muted); }
    .desc { margin: 10px 0 0; color: var(--tmh-muted); font-size: 14px; line-height: 1.5; }

    .metaRow { margin-top: 12px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .tags { display:flex; flex-wrap:wrap; gap:8px; }
    .pill {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,70,175,0.22);
      background: rgba(0,207,253,0.08);
      color: #0046AF;
      text-decoration: none;
      white-space: nowrap;
    }
    .pill:hover { border-color: rgba(0,70,175,0.38); }

    .source {
      font-size: 12px;
      color: var(--tmh-muted);
      text-decoration: none;
      white-space: nowrap;
    }
    .source:hover { text-decoration: underline; }

    .empty {
      border: 1px dashed var(--tmh-border);
      border-radius: 14px;
      padding: 20px;
      color: var(--tmh-muted);
      background: var(--tmh-card);
    }
  </style>
</BaseLayout>
