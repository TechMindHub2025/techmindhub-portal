---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const sort = (Astro.url.searchParams.get("sort") ?? "newest").toLowerCase();
const tag = (Astro.url.searchParams.get("tag") ?? "").trim().toLowerCase();

const all = await getCollection("posts");

// Only published
let posts = all
  .filter((p) => p.data.status === "published")
  .filter((p) => (tag ? (p.data.tags ?? []).map((t) => t.toLowerCase()).includes(tag) : true));

// Sort
posts = posts.sort((a, b) => {
  const da = new Date(a.data.pubDate).getTime();
  const db = new Date(b.data.pubDate).getTime();

  if (sort === "oldest") return da - db;
  // newest (default)
  return db - da;
});

const allTags = Array.from(
  new Set(
    all
      .filter((p) => p.data.status === "published")
      .flatMap((p) => p.data.tags ?? [])
      .map((t) => t.trim())
      .filter(Boolean)
  )
).sort((a, b) => a.localeCompare(b));
---

<BaseLayout title="Posts — TechMind Hub" description="Latest TechMind Hub posts and notes.">
  <section class="page">
    <div class="pageHead">
      <div>
        <h1>Posts</h1>
        <p class="lead">
          A curated feed of signals across AI, robotics, automation, and enterprise tech.
        </p>
      </div>

      <form class="controls" method="get" action="/posts">
        {tag ? <input type="hidden" name="tag" value={tag} /> : null}
        <label class="control">
          <span>Sort</span>
          <select name="sort" onchange="this.form.submit()">
            <option value="newest" selected={sort === "newest"}>Newest</option>
            <option value="oldest" selected={sort === "oldest"}>Oldest</option>
          </select>
        </label>
      </form>
    </div>

    <div class="tagBar">
      <a class={"tagChip " + (!tag ? "active" : "")} href="/posts">All</a>
      {allTags.map((t) => (
        <a
          class={"tagChip " + (tag === t.toLowerCase() ? "active" : "")}
          href={`/posts?tag=${encodeURIComponent(t)}&sort=${encodeURIComponent(sort)}`}
        >
          #{t}
        </a>
      ))}
    </div>

    {posts.length === 0 ? (
      <div class="empty">
        <p>No posts found{tag ? ` for #${tag}` : ""}.</p>
      </div>
    ) : (
      <div class="grid">
        {posts.map((post) => {
          const href = `/posts/${post.slug}/`;
          const cover = post.data.cover_card || post.data.cover_hero;

          return (
            <article class="card">
              <a class="cardLink" href={href} aria-label={post.data.title}></a>

              <img
                class="cover"
                src={cover}
                alt={post.data.title}
                loading="lazy"
              />

              <div class="cardBody">
                <h2 class="title">{post.data.title}</h2>

                <time class="date" datetime={new Date(post.data.pubDate).toISOString()}>
                  {new Date(post.data.pubDate).toISOString().slice(0, 10)}
                </time>

                <p class="desc">{post.data.description}</p>

                <div class="metaRow">
                  <div class="tags">
                    {(post.data.tags ?? []).slice(0, 6).map((t) => (
                      <a
                        class="pill"
                        href={`/posts?tag=${encodeURIComponent(t)}&sort=${encodeURIComponent(sort)}`}
                      >
                        #{t}
                      </a>
                    ))}
                  </div>

                  {post.data.source_url && (
                    <a class="source" href={post.data.source_url} target="_blank" rel="noreferrer">
                      Source ↗
                    </a>
                  )}
                </div>
              </div>
            </article>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
